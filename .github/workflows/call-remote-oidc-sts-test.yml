name: OIDC in base -> call remote OIDC STS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  base-oidc:
    name: Base OIDC assume-role
    runs-on: ubuntu-latest
    outputs:
      base_sts_arn: ${{ steps.base_sts.outputs.arn }}
    steps:
      - name: Assume AWS role via GitHub OIDC (base repo)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/gh-oidc-poc-github-federation
          aws-region: eu-west-1

      - name: Base STS get-caller-identity
        id: base_sts
        shell: bash
        run: |
          aws sts get-caller-identity
          arn="$(aws sts get-caller-identity --query Arn --output text)"
          echo "arn=${arn}" >> "$GITHUB_OUTPUT"

  call-remote:
    name: Call remote reusable workflow (OIDC STS)
    needs: base-oidc
    uses: datagero/poc-github-federation-dp/.github/workflows/reusable-aws-cred-sts.yml@main
    with:
      caller_note: "caller=${{ github.repository }} run_id=${{ github.run_id }} branch=${{ github.ref_name }}"
      aws_region: eu-west-1
      role_to_assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/gh-oidc-poc-github-federation

  summary:
    name: Summary (base vs remote)
    runs-on: ubuntu-latest
    needs: [base-oidc, call-remote]
    steps:
      - name: Print summary
        run: |
          echo "===================="
          echo "OIDC + REMOTE CALL SUMMARY"
          echo "===================="
          echo "Repo:       ${{ github.repository }}"
          echo "Run ID:     ${{ github.run_id }}"
          echo "Branch:     ${{ github.ref_name }}"
          echo ""
          echo "Base STS ARN:   ${{ needs.base-oidc.outputs.base_sts_arn }}"
          echo "Remote STS ARN: ${{ needs.call-remote.outputs.sts_arn }}"
          echo ""
          if [ "${{ needs.base-oidc.outputs.base_sts_arn }}" = "${{ needs.call-remote.outputs.sts_arn }}" ]; then
            echo "✅ Same identity observed in base + remote"
          else
            echo "❌ Different identity (unexpected if creds were forwarded)"
            exit 1
          fi

